version: '2'
services:
    boulder:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            FAKE_DNS: 127.0.0.1
            PKCS11_PROXY_SOCKET: tcp://boulder-hsm:5657
            BOULDER_CONFIG_DIR: test/config
        volumes:
          - .:/go/src/github.com/letsencrypt/boulder
          - /tmp:/tmp
        network_mode: bridge
        extra_hosts:
          - le.wtf:127.0.0.1
          - boulder:127.0.0.1
        links:
          - bhsm:boulder-hsm
          - bmysql:boulder-mysql
    bhsm:
        # To minimize the fetching of various layers this should match
        # the FROM image and tag in boulder/Dockerfile
        image: letsencrypt/boulder-tools:2017-10-05
        environment:
            PKCS11_DAEMON_SOCKET: tcp://0.0.0.0:5657
        command: /usr/local/bin/pkcs11-daemon /usr/lib/softhsm/libsofthsm2.so
        expose:
          - 5657
        network_mode: bridge
    bmysql:
        image: mariadb:10.1
        network_mode: bridge
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        command: mysqld --bind-address=0.0.0.0
        logging:
            driver: none
    prom:
        image: prom/prometheus:v1.8.2
        network_mode: bridge
        volumes:
          - $PWD/test/prometheus/:/promconf/
        command: -config.file /promconf/prometheus.yml
        links:
          - boulder
